<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Experimental Design Scenarios Interactive</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #1d4ed8;
      --accent-soft: #dbeafe;
      --ok: #166534;
      --ok-bg: #dcfce7;
      --warn: #92400e;
      --warn-bg: #fef3c7;
      --danger: #991b1b;
      --danger-bg: #fee2e2;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.45;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
    }
    h1 { margin: 0 0 6px 0; font-size: 1.5rem; }
    .sub { color: var(--muted); margin: 0; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    button {
      border: 1px solid var(--line);
      background: white;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
    }
    .section-title {
      font-weight: 700;
      margin: 14px 0 8px;
      font-size: 1rem;
    }
    .scenario-controls {
      display: grid;
      grid-template-columns: 1.1fr auto auto auto;
      gap: 10px;
      align-items: end;
      margin-bottom: 12px;
    }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    select, input[type="text"], textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 0.95rem;
      background: white;
    }
    textarea { min-height: 78px; resize: vertical; }
    .scenario-text {
      white-space: pre-wrap;
      background: #fbfcfe;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      min-height: 180px;
      font-size: 1rem;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .helper { color: var(--muted); font-size: 0.85rem; margin-top: 3px; }
    .footer-note { color: var(--muted); font-size: 0.9rem; margin-top: 10px; }
    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      display: none;
    }
    .status.show { display: block; }
    .status.ok { background: var(--ok-bg); color: var(--ok); border-color: #bbf7d0; }
    .status.warn { background: var(--warn-bg); color: var(--warn); border-color: #fde68a; }
    .status.danger { background: var(--danger-bg); color: var(--danger); border-color: #fecaca; }
    .sticky-actions {
      position: sticky;
      bottom: 10px;
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      background: rgba(247,248,251,0.85);
      backdrop-filter: blur(4px);
      padding-top: 8px;
    }
    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
      margin-top: 6px;
    }
    .mini-table th, .mini-table td {
      border: 1px solid var(--line);
      padding: 8px;
      vertical-align: top;
    }
    .mini-table th { background: #f9fafb; text-align: left; }
    .summary-cell-empty { color: #9ca3af; font-style: italic; }
    .completion-chip {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.8rem;
      background: #f9fafb;
    }
    .answer-review {
      margin-top: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
      display: none;
    }
    .answer-review.show { display: block; }
    .answer-review h4 { margin: 0 0 8px; }
    .score-box {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
    }
    .answer-list {
      margin: 0;
      padding-left: 18px;
    }
    .answer-list li { margin-bottom: 8px; }
    details summary {
      cursor: pointer;
      font-weight: 700;
      margin-top: 14px;
    }
    .checklist { margin: 8px 0 0; padding-left: 20px; }
    @media (max-width: 900px) {
      .row, .row3 { grid-template-columns: 1fr; }
      .scenario-controls { grid-template-columns: 1fr; }
      .sticky-actions { position: static; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Experimental Design Scenarios Interactive Practice</h1>
      <p class="sub">CON 503 • Identify experimental type, specific design, IV/DV, random assignment, and control group.</p>
      <div class="toolbar">
        <button id="resetCurrent">Reset Current Scenario</button>
        <button id="resetAll">Reset All</button>
        <button id="exportCSV">Export Responses (Excel .csv)</button>
        <button id="checkAnswersBtn" class="primary">Check Answers (after all 4 scenarios)</button>
      </div>
      <p class="footer-note">Student responses are saved locally in this browser (localStorage). Use Export to save a copy you can open in Excel.</p>
    </div>

    <div class="grid">
      <div class="panel" id="workPanel">
        <div class="section-title">Work on a Scenario</div>

        <div class="scenario-controls">
          <div>
            <label for="scenarioSelect">Choose Scenario</label>
            <select id="scenarioSelect"></select>
          </div>
          <button id="loadScenario">Load Scenario</button>
          <button id="prevScenario">← Previous</button>
          <button id="nextScenario">Next →</button>
        </div>

        <div id="scenarioHeader" class="section-title">Scenario 1 <span class="completion-chip" id="completionChip">Core fields complete: 0/6</span></div>
        <div id="scenarioText" class="scenario-text"></div>

        <div class="row">
          <div>
            <label for="experimentalType">Experimental Type</label>
            <select id="experimentalType">
              <option value="">-- Select --</option>
              <option>True experiment</option>
              <option>Quasi-experiment</option>
              <option>Pre-experiment</option>
            </select>
          </div>
          <div>
            <label for="specificDesign">Specific Design</label>
            <select id="specificDesign">
              <option value="">-- Select --</option>
              <option>Randomized block design</option>
              <option>Posttest-only control group design</option>
              <option>Pretest-posttest control group design</option>
              <option>Nonequivalent control group pretest-posttest design</option>
              <option>One-group pretest-posttest design</option>
              <option>One-shot case study</option>
              <option>Matched-pairs randomized design</option>
              <option>Other / explain in notes</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="independentVar">Independent Variable(s)</label>
            <textarea id="independentVar" placeholder="Example: break schedule / training / boot type"></textarea>
          </div>
          <div>
            <label for="dependentVar">Dependent Variable(s)</label>
            <textarea id="dependentVar" placeholder="Example: productivity, safety awareness, fatigue"></textarea>
          </div>
        </div>

        <div class="row3">
          <div>
            <label for="randomAssignment">Random Assignment?</label>
            <select id="randomAssignment">
              <option value="">-- Select --</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>
          <div>
            <label for="controlGroup">Control Group Included?</label>
            <select id="controlGroup">
              <option value="">-- Select --</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>
          <div>
            <label for="confidence">Confidence</label>
            <select id="confidence">
              <option value="">-- Select --</option>
              <option>High</option>
              <option>Medium</option>
              <option>Low</option>
            </select>
          </div>
        </div>

        <label for="reasoning">Reasoning / Notes (optional but recommended)</label>
        <textarea id="reasoning" placeholder="Explain what clues you used (random assignment, control/comparison group, pretest/posttest, matching, manipulation)."></textarea>
        <div class="helper">Tip: Save after completing each scenario. Your saved answers will update the worksheet summary below.</div>

        <div class="sticky-actions">
          <button class="primary" id="saveScenario">Save Scenario to Worksheet Summary</button>
          <button id="checkCompletion">Check Current Scenario Completion</button>
        </div>
        <div id="statusBox" class="status"></div>
      </div>

      <div class="panel">
        <div class="section-title">Worksheet Summary (All 4 Scenarios)</div>
        <div class="helper">This table updates when you click <strong>Save Scenario to Worksheet Summary</strong>.</div>
        <table class="mini-table" id="summaryTable">
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Experimental Type</th>
              <th>Specific Design</th>
              <th>IV(s)</th>
              <th>DV(s)</th>
              <th>Random Assignment?</th>
              <th>Control Group?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="answerReview" class="answer-review">
          <h4>Worksheet Answer Review (Unlocked)</h4>
          <div class="score-box" id="scoreBox"></div>
          <div id="answerReviewContent"></div>
          <p class="helper">Note: Exact variable wording can vary. Treat IV/DV wording as concept checks, and use instructor discussion for acceptable alternatives.</p>
        </div>

        <details>
          <summary>Quick concept guide</summary>
          <ul class="checklist">
            <li><strong>True experiment:</strong> manipulates IV and uses random assignment.</li>
            <li><strong>Quasi-experiment:</strong> no random assignment, but may include comparison groups and/or pre-post measures.</li>
            <li><strong>Pre-experiment:</strong> weaker design control (often no random assignment and/or no control group).</li>
          </ul>
        </details>
      </div>
    </div>
  </div>

  <script>
    const scenarios = [
      {
        id: 1,
        title: 'Scenario 1',
        text: `A researcher wants to study how break frequency affects worker productivity in a construction firm. Since the type of work may influence how break schedules impact productivity, workers are first grouped based on job type:\n• Skilled Laborers (e.g., carpenters, electricians)\n• Heavy Equipment Operators\nWithin each job type, workers are then randomly assigned to one of three break schedules:\n• Group A: 15-minute breaks every 2 hours\n• Group B: 30-minute breaks every 4 hours\n• Group C: No scheduled breaks\nResearchers compare productivity outcomes across groups.`,
        key: {
          experimentalType: 'True experiment',
          specificDesign: 'Randomized block design',
          independentVar: 'Break schedule / break frequency (and duration)',
          dependentVar: 'Worker productivity',
          randomAssignment: 'Yes',
          controlGroup: 'Yes',
          notes: 'Blocked by job type, then randomized within blocks. Group C functions as a control/comparison condition.'
        }
      },
      {
        id: 2,
        title: 'Scenario 2',
        text: `A construction manager wants to improve workers’ safety awareness by placing large posters on job sites that display common hazards and safety rules. After two months, workers are surveyed about their awareness of hazards.`,
        key: {
          experimentalType: 'Pre-experiment',
          specificDesign: 'One-shot case study',
          independentVar: 'Safety poster intervention',
          dependentVar: 'Workers’ safety awareness (survey responses)',
          randomAssignment: 'No',
          controlGroup: 'No',
          notes: 'Intervention plus post-measure only; no pretest, no control group, no random assignment.'
        }
      },
      {
        id: 3,
        title: 'Scenario 3',
        text: `A construction company implements a new leadership training program for site supervisors aimed at improving safety culture and compliance. The company selects two similar construction sites with ongoing projects: at one site, supervisors receive the leadership training, while at the other site, they do not. Before the training, data on safety violation rates, near-miss reports, and worker perception of safety culture are collected at both sites. After a three-month period, the same data are collected again to assess the impact of the training.`,
        key: {
          experimentalType: 'Quasi-experiment',
          specificDesign: 'Nonequivalent control group pretest-posttest design',
          independentVar: 'Leadership training for site supervisors',
          dependentVar: 'Safety violation rates; near-miss reports; worker perception of safety culture',
          randomAssignment: 'No',
          controlGroup: 'Yes',
          notes: 'Comparison sites + pre/post measures, but no random assignment.'
        }
      },
      {
        id: 4,
        title: 'Scenario 4',
        text: `A construction company wants to test whether a new type of safety boot reduces worker fatigue compared to standard boots. To control for individual differences, each worker is paired with another worker of similar physical condition, workload, and experience level. Within each pair, one worker is randomly assigned to wear the new safety boots, while the other wears the standard boots. After a full work shift, researchers measure fatigue levels in both groups and compare the results within each matched pair.`,
        key: {
          experimentalType: 'True experiment',
          specificDesign: 'Matched-pairs randomized design',
          independentVar: 'Type of safety boot (new vs standard)',
          dependentVar: 'Worker fatigue level',
          randomAssignment: 'Yes',
          controlGroup: 'Yes',
          notes: 'Matched pairs + random assignment within pairs. Standard boot acts as comparison/control condition.'
        }
      }
    ];

    const STORAGE_KEY = 'exp_design_scenarios_v2';
    let currentIndex = 0;
    let answerReviewUnlocked = false;
    let state = loadState();

    const els = {
      scenarioSelect: document.getElementById('scenarioSelect'),
      loadScenario: document.getElementById('loadScenario'),
      prevScenario: document.getElementById('prevScenario'),
      nextScenario: document.getElementById('nextScenario'),
      scenarioHeader: document.getElementById('scenarioHeader'),
      scenarioText: document.getElementById('scenarioText'),
      completionChip: document.getElementById('completionChip'),
      experimentalType: document.getElementById('experimentalType'),
      specificDesign: document.getElementById('specificDesign'),
      independentVar: document.getElementById('independentVar'),
      dependentVar: document.getElementById('dependentVar'),
      randomAssignment: document.getElementById('randomAssignment'),
      controlGroup: document.getElementById('controlGroup'),
      confidence: document.getElementById('confidence'),
      reasoning: document.getElementById('reasoning'),
      saveScenario: document.getElementById('saveScenario'),
      checkCompletion: document.getElementById('checkCompletion'),
      statusBox: document.getElementById('statusBox'),
      summaryTableBody: document.querySelector('#summaryTable tbody'),
      resetCurrent: document.getElementById('resetCurrent'),
      resetAll: document.getElementById('resetAll'),
      exportCSV: document.getElementById('exportCSV'),
      checkAnswersBtn: document.getElementById('checkAnswersBtn'),
      answerReview: document.getElementById('answerReview'),
      scoreBox: document.getElementById('scoreBox'),
      answerReviewContent: document.getElementById('answerReviewContent')
    };

    function emptyResponse() {
      return {
        experimentalType: '',
        specificDesign: '',
        independentVar: '',
        dependentVar: '',
        randomAssignment: '',
        controlGroup: '',
        confidence: '',
        reasoning: '',
        savedToSummary: false
      };
    }

    function normalize(text='') {
      return text.toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
    }

    function fieldFilledCount(r) {
      const keys = ['experimentalType','specificDesign','independentVar','dependentVar','randomAssignment','controlGroup'];
      return keys.filter(k => (r[k] || '').trim() !== '').length;
    }

    function isCoreComplete(r) {
      return fieldFilledCount(r) === 6;
    }

    function allScenariosCompleteAndSaved() {
      return scenarios.every(s => {
        const r = state[s.id];
        return r && isCoreComplete(r) && r.savedToSummary;
      });
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const initial = {};
      scenarios.forEach(s => initial[s.id] = emptyResponse());
      if (!raw) return initial;
      try {
        const parsed = JSON.parse(raw);
        scenarios.forEach(s => {
          initial[s.id] = { ...emptyResponse(), ...(parsed[s.id] || {}) };
        });
        return initial;
      } catch {
        return initial;
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function showStatus(msg, type='ok') {
      els.statusBox.textContent = msg;
      els.statusBox.className = `status show ${type}`;
      setTimeout(() => { els.statusBox.className = 'status'; }, 3000);
    }

    function currentScenario() { return scenarios[currentIndex]; }

    function populateScenarioSelect() {
      els.scenarioSelect.innerHTML = '';
      scenarios.forEach((s, idx) => {
        const r = state[s.id] || emptyResponse();
        const opt = document.createElement('option');
        const suffix = r.savedToSummary ? ' ✓ Saved' : '';
        opt.value = idx;
        opt.textContent = `${s.title}${suffix}`;
        els.scenarioSelect.appendChild(opt);
      });
      els.scenarioSelect.value = String(currentIndex);
    }

    function renderWorkPanel() {
      const s = currentScenario();
      const r = state[s.id] || emptyResponse();
      els.scenarioHeader.innerHTML = `${s.title} <span class="completion-chip" id="completionChipInner">Core fields complete: ${fieldFilledCount(r)}/6${r.savedToSummary ? ' • Saved to summary' : ''}</span>`;
      els.scenarioText.textContent = s.text;
      els.experimentalType.value = r.experimentalType || '';
      els.specificDesign.value = r.specificDesign || '';
      els.independentVar.value = r.independentVar || '';
      els.dependentVar.value = r.dependentVar || '';
      els.randomAssignment.value = r.randomAssignment || '';
      els.controlGroup.value = r.controlGroup || '';
      els.confidence.value = r.confidence || '';
      els.reasoning.value = r.reasoning || '';
      els.scenarioSelect.value = String(currentIndex);
      updateAnswerReviewVisibility();
    }

    function saveCurrentInputsToState(markSaved=false) {
      const s = currentScenario();
      const previousSavedFlag = state[s.id]?.savedToSummary || false;
      state[s.id] = {
        experimentalType: els.experimentalType.value,
        specificDesign: els.specificDesign.value,
        independentVar: els.independentVar.value.trim(),
        dependentVar: els.dependentVar.value.trim(),
        randomAssignment: els.randomAssignment.value,
        controlGroup: els.controlGroup.value,
        confidence: els.confidence.value,
        reasoning: els.reasoning.value.trim(),
        savedToSummary: markSaved ? true : previousSavedFlag
      };
      saveState();
    }

    function renderSummary() {
      els.summaryTableBody.innerHTML = '';
      scenarios.forEach(s => {
        const r = state[s.id] || emptyResponse();
        const tr = document.createElement('tr');
        const notSaved = !r.savedToSummary;
        tr.innerHTML = `
          <td>${s.title}${notSaved ? ' <span class="summary-cell-empty">(not saved)</span>' : ''}</td>
          <td>${cell(r.savedToSummary ? r.experimentalType : '')}</td>
          <td>${cell(r.savedToSummary ? r.specificDesign : '')}</td>
          <td>${cell(r.savedToSummary ? r.independentVar : '')}</td>
          <td>${cell(r.savedToSummary ? r.dependentVar : '')}</td>
          <td>${cell(r.savedToSummary ? r.randomAssignment : '')}</td>
          <td>${cell(r.savedToSummary ? r.controlGroup : '')}</td>
        `;
        els.summaryTableBody.appendChild(tr);
      });
      populateScenarioSelect();
      updateAnswerReviewVisibility();
    }

    function cell(value) {
      const v = (value || '').trim();
      if (!v) return '<span class="summary-cell-empty">—</span>';
      return escapeHtml(v);
    }

    function escapeHtml(str='') {
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function checkCurrentCompletion() {
      saveCurrentInputsToState(false);
      const r = state[currentScenario().id];
      const missing = [];
      ['experimentalType','specificDesign','independentVar','dependentVar','randomAssignment','controlGroup'].forEach(k => {
        if (!(r[k] || '').trim()) missing.push(k);
      });
      if (missing.length === 0) {
        showStatus('Nice — all core fields are completed for this scenario. Click “Save Scenario to Worksheet Summary.”', 'ok');
      } else {
        showStatus('Still missing: ' + missing.join(', '), 'warn');
      }
      renderWorkPanel();
    }

    function saveScenarioToSummary() {
      saveCurrentInputsToState(false);
      const s = currentScenario();
      const r = state[s.id];
      if (!isCoreComplete(r)) {
        showStatus('Please complete all 6 core fields before saving this scenario to the worksheet summary.', 'warn');
        return;
      }
      state[s.id].savedToSummary = true;
      saveState();
      renderSummary();
      renderWorkPanel();
      showStatus(`${s.title} saved to worksheet summary.`, 'ok');
    }

    function updateAnswerReviewVisibility() {
      const unlocked = answerReviewUnlocked && allScenariosCompleteAndSaved();
      els.answerReview.classList.toggle('show', unlocked);
      if (!allScenariosCompleteAndSaved()) {
        els.checkAnswersBtn.disabled = false;
      }
    }

    function compareAgainstKey() {
      if (!allScenariosCompleteAndSaved()) {
        showStatus('Complete and save all 4 scenarios before checking answers.', 'danger');
        return;
      }
      answerReviewUnlocked = true;

      let exactChecks = 0;
      let exactCorrect = 0;
      const rows = [];
      scenarios.forEach(s => {
        const r = state[s.id];
        const k = s.key;
        const checks = [
          ['Experimental Type', r.experimentalType, k.experimentalType, r.experimentalType === k.experimentalType],
          ['Specific Design', r.specificDesign, k.specificDesign, r.specificDesign === k.specificDesign],
          ['Random Assignment', r.randomAssignment, k.randomAssignment, r.randomAssignment === k.randomAssignment],
          ['Control Group', r.controlGroup, k.controlGroup, r.controlGroup === k.controlGroup]
        ];
        exactChecks += checks.length;
        exactCorrect += checks.filter(c => c[3]).length;
        rows.push({ scenario: s, response: r, checks });
      });

      els.scoreBox.textContent = `Exact-match score (design type / specific design / random assignment / control group): ${exactCorrect} / ${exactChecks}. IV and DV wording are reviewed conceptually.`;

      els.answerReviewContent.innerHTML = rows.map(({scenario, response, checks}) => {
        const checksHtml = checks.map(([label, student, key, ok]) => `
          <li><strong>${label}:</strong> ${ok ? '✅' : '❌'} Your answer: <em>${escapeHtml(student || '—')}</em> | Suggested key: <em>${escapeHtml(key)}</em></li>
        `).join('');

        return `
          <div style="margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid #e5e7eb;">
            <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(scenario.title)}</div>
            <ul class="answer-list">${checksHtml}</ul>
            <div style="margin-top:6px;"><strong>Your IV(s):</strong> ${escapeHtml(response.independentVar || '—')}</div>
            <div><strong>Suggested IV(s):</strong> ${escapeHtml(scenario.key.independentVar)}</div>
            <div style="margin-top:4px;"><strong>Your DV(s):</strong> ${escapeHtml(response.dependentVar || '—')}</div>
            <div><strong>Suggested DV(s):</strong> ${escapeHtml(scenario.key.dependentVar)}</div>
            <div style="margin-top:6px;"><strong>Why (suggested reasoning):</strong> ${escapeHtml(scenario.key.notes)}</div>
          </div>
        `;
      }).join('');

      els.answerReview.classList.add('show');
      showStatus('Answer review unlocked. Great job completing the full worksheet first!', 'ok');
    }

    function goToScenario(index) {
      saveCurrentInputsToState(false);
      currentIndex = Math.max(0, Math.min(scenarios.length - 1, index));
      renderWorkPanel();
      populateScenarioSelect();
    }

    function exportCSV() {
      saveCurrentInputsToState(false);
      const headers = [
        'Scenario ID','Scenario Title','Saved to Summary','Experimental Type','Specific Design','Independent Variable(s)','Dependent Variable(s)','Random Assignment','Control Group','Confidence','Reasoning/Notes'
      ];
      const lines = [headers.map(csvEscape).join(',')];
      scenarios.forEach(s => {
        const r = state[s.id] || emptyResponse();
        const row = [
          s.id,
          s.title,
          r.savedToSummary ? 'Yes' : 'No',
          r.experimentalType,
          r.specificDesign,
          r.independentVar,
          r.dependentVar,
          r.randomAssignment,
          r.controlGroup,
          r.confidence,
          r.reasoning
        ];
        lines.push(row.map(csvEscape).join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'experimental_design_scenarios_responses.csv';
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Exported Excel-compatible CSV file.', 'ok');
    }

    function csvEscape(value) {
      const str = String(value ?? '');
      if (/[,"\n]/.test(str)) return '"' + str.replace(/"/g, '""') + '"';
      return str;
    }

    // Event handlers
    document.getElementById('loadScenario').addEventListener('click', () => {
      goToScenario(Number(els.scenarioSelect.value));
    });
    els.scenarioSelect.addEventListener('change', () => goToScenario(Number(els.scenarioSelect.value)));
    els.prevScenario.addEventListener('click', () => goToScenario(currentIndex - 1));
    els.nextScenario.addEventListener('click', () => goToScenario(currentIndex + 1));
    els.saveScenario.addEventListener('click', saveScenarioToSummary);
    els.checkCompletion.addEventListener('click', checkCurrentCompletion);
    els.exportCSV.addEventListener('click', exportCSV);
    els.checkAnswersBtn.addEventListener('click', compareAgainstKey);

    els.resetCurrent.addEventListener('click', () => {
      const s = currentScenario();
      state[s.id] = emptyResponse();
      saveState();
      renderSummary();
      renderWorkPanel();
      showStatus(`${s.title} reset.`, 'ok');
    });

    els.resetAll.addEventListener('click', () => {
      if (!confirm('Reset all scenarios? This clears all responses saved in this browser.')) return;
      scenarios.forEach(s => state[s.id] = emptyResponse());
      answerReviewUnlocked = false;
      saveState();
      renderSummary();
      renderWorkPanel();
      showStatus('All scenarios reset.', 'ok');
    });

    ['experimentalType','specificDesign','independentVar','dependentVar','randomAssignment','controlGroup','confidence','reasoning']
      .forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('change', () => {
          saveCurrentInputsToState(false);
          renderWorkPanel();
        });
        if (el.tagName === 'TEXTAREA') {
          el.addEventListener('blur', () => {
            saveCurrentInputsToState(false);
            renderWorkPanel();
          });
        }
      });

    function init() {
      populateScenarioSelect();
      renderSummary();
      renderWorkPanel();
    }
    init();
  </script>
</body>
</html>
